# ./create-stack.sh eks-cluster-capstone eks-cluster.yml
# ./delete-stack.sh eks-cluster-capstone
---
AWSTemplateFormatVersion: 2010-09-09
Description: Amazon EKS Cluster

Parameters:
    ClusterName:
        Description: The default name for cluster control plane
        Type: String
        Default: "eks-cluster-capstone"
        
    InfraStackName:
        Description: The default name for cluster network stack definition (VPC, Subnets, SecurityGroups)
        Type: String
        Default: "eks-infra-capstone"
 
Resources:
    EksClusterRole:
        Type: 'AWS::IAM::Role'
        Properties:
          AssumeRolePolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Principal:
                Service:
                - eks.amazonaws.com
              Action:
              - sts:AssumeRole
          ManagedPolicyArns:
            - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy

    CreatedCluster:
        Type: 'AWS::EKS::Cluster'
        DependsOn: EksClusterRole
        Properties:
            Name: !Ref ClusterName
            Version: '1.17'
            RoleArn: !GetAtt EksClusterRole.Arn
            ResourcesVpcConfig:
                SecurityGroupIds:
                    Fn::Split:
                        - ","
                        - Fn::ImportValue:
                            Fn::Sub:
                                "${InfraStackName}-SecurityGroup"
                SubnetIds:
                    Fn::Split:
                        - ","
                        - Fn::ImportValue:
                            Fn::Sub:
                                "${InfraStackName}-SubnetIds"

Outputs:
  CreatedClusterName:
    Description: Name of created cluster
    Value: !Ref CreatedCluster
    
  RoleArn:
    Description: The role that Amazon EKS will use to create AWS resources for Kubernetes clusters
    Value: !GetAtt EksClusterRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RoleArn"
      
# aws eks get-token --cluster-name eks-cluster-capstone --role-arn arn:aws:iam::406422950273:role/eks-cluster-manager-role
# aws eks list-clusters
# aws eks describe-cluster --name eks-cluster-capstone
# follow this with setting up ~/.kube/config with command like
# if experience error: "'NoneType' object is not iterable" delete current ~/.kube/config
# https://github.com/aws/aws-cli/issues/4843
# aws eks --region eu-west-2 update-kubeconfig --name eks-cluster-capstone --role-arn arn:aws:iam::406422950273:role/eks-cluster-manager-role
# aws iam list-users
# aws sts get-caller-identity